<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>bdIndicators Day View</title>
    <link href="themes/default/easyui.css" rel="stylesheet" type="text/css">
    <link href="themes/icon.css" rel="stylesheet" type="text/css">
    <link href="themes/demo.css" rel="stylesheet" type="text/css">
    <script src="https://registry.npmmirror.com/echarts/5.5.0/files/dist/echarts.min.js"></script>
    <script src="js/jquery.min.js" type="text/javascript"></script>
    <script src="js/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="js/jquery.edatagrid.js" type="text/javascript"></script>
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/stock/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/stock/modules/accessibility.js"></script>
    <style>
        * {
          margin: 0;
          padding: 0;
        }
        .chart-container {
            width: 400px;
            height: 280px;
            margin-bottom: 2px;
            background-color: #FFFFCC;
        }
        .income-container {
            width: 400px;
            height: 120px;
            margin-bottom: 2px;
            background-color: #FFFFCC;
        }
        .range-container {
            width: 400px;
            height: 280px;
            margin-bottom: 2px;
        }
        .index-container {
            width: 400px;
            height: 280px;
            margin-bottom: 2px;
            background-color: #FFFFCC;
        }
        .vertical-stockId {
            writing-mode: vertical-rl;
            text-orientation: upright;
            border: 1px solid #000;
            padding: 10px;
            font-size: 5px;
        }

        th, td {
          text-align: left;
          padding: 10px;
        }
        .toggleButton {
            background-color: grey; /* 设置按钮背景颜色 */
            color: black; /* 按钮文字颜色 */
            padding: 10px 15px; /* 内边距 */
            border: none; /* 去掉边框 */
            border-radius: 5px; /* 圆角 */
            cursor: pointer; /* 鼠标悬浮样式 */
            text-align: center; /* 居中 */
            text-decoration: none; /* 去掉下划线 */
        }
    </style>
</head>
<body>

<table border="1" id="mainTable">
</table>
<button id="toggleWk"  class="easyui-linkbutton" >toggleWk</button>
<button class="toggleButton" id="toggle_300" >Toggle 300K</button>
<table border="1" id="myTable"></table>

<script>
    const serverIp = window.location.hostname === 'localhost' ? 'localhost' : '43.139.165.209';
</script>
<script>
    var isWeekly = false;
    document.addEventListener('DOMContentLoaded', function () {
           function loadTableData() {
              fetch(`http://${serverIp}:8888/bd/indicatorsView/false`)
                 .then(response => response.text())
                 .then(data => {
                    const dataContainer = document.getElementById('myTable');
                    dataContainer.innerHTML = data;
                 })
                 .catch(error => {
                    console.error('Error fetching data:', error);
                 })
           }

     loadTableData();

    async function getDivs() {
       const spans = document.querySelectorAll('div[id^="span_"]');
        spans.forEach(span => {
           createETFChart(span); // Pass each span element to the function
        });
        // bindEvents(); // Uncomment if you have this function defined elsewhere
    }

    // Delay calling getDivs to ensure dynamic spans are loaded, if any
    setTimeout(function() {
          getDivs();
    }, 1500);

    }); // End of DOMContentLoaded


    async function createETFChart(containerElement) { // Renamed 'span' to 'containerElement' for clarity
        // ECharts integration for each individual containerElement starts here
        var myChart = echarts.init(containerElement); // Initialize chart on the passed element
        var option;

        const rawData = [
          [100, 302, 301, 334, 390, 330, 320],
          [320, 132, 101, 134, 90, 230, 210],
          [220, 182, 191, 234, 290, 330, 310],
          [150, 212, 201, 154, 190, 330, 410],
          [820, 832, 901, 934, 1290, 1330, 1320]
        ];
        const totalData = [];
        for (let i = 0; i < rawData[0].length; ++i) {
          let sum = 0;
          for (let j = 0; j < rawData.length; ++j) {
            sum += rawData[j][i];
          }
          totalData.push(sum);
        }
        const grid = {
          left: 100,
          right: 100,
          top: 50,
          bottom: 50
        };
        const gridWidth = myChart.getWidth() - grid.left - grid.right;
        const gridHeight = myChart.getHeight() - grid.top - grid.bottom;
        const categoryWidth = gridWidth / rawData[0].length;
        const barWidth = categoryWidth * 0.6;
        const barPadding = (categoryWidth - barWidth) / 2;
        const series = [
          'Direct',
          'Mail Ad',
          'Affiliate Ad',
          'Video Ad',
          'Search Engine'
        ].map((name, sid) => {
          return {
            name,
            type: 'bar',
            stack: 'total',
            barWidth: '60%',
            label: {
              show: true,
              formatter: (params) => Math.round(params.value * 1000) / 10 + '%'
            },
            data: rawData[sid].map((d, did) =>
              totalData[did] <= 0 ? 0 : d / totalData[did]
            )
          };
        });
        const color = ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de'];
        const elements = [];
        for (let j = 1, jlen = rawData[0].length; j < jlen; ++j) {
          const leftX = grid.left + categoryWidth * j - barPadding;
          const rightX = leftX + barPadding * 2;
          let leftY = grid.top + gridHeight;
          let rightY = leftY;
          for (let i = 0, len = series.length; i < len; ++i) {
            const points = [];
            const leftBarHeight = (rawData[i][j - 1] / totalData[j - 1]) * gridHeight;
            points.push([leftX, leftY]);
            points.push([leftX, leftY - leftBarHeight]);
            const rightBarHeight = (rawData[i][j] / totalData[j]) * gridHeight;
            points.push([rightX, rightY - rightBarHeight]);
            points.push([rightX, rightY]);
            points.push([leftX, leftY]);
            leftY -= leftBarHeight;
            rightY -= rightBarHeight;
            elements.push({
              type: 'polygon',
              shape: {
                points
              },
              style: {
                fill: color[i],
                opacity: 0.25
              }
            });
          }
        }
        option = {
          legend: {
            selectedMode: false
          },
          grid,
          yAxis: {
            type: 'value'
          },
          xAxis: {
            type: 'category',
            data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
          },
          series,
          graphic: {
            elements
          }
        };

        myChart.setOption(option);
        // ECharts integration for each individual containerElement ends here
    }
</script>
</body>
</html>