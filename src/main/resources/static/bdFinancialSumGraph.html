<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>bdIndicators Day View</title>
    <link href="themes/default/easyui.css" rel="stylesheet" type="text/css">
    <link href="themes/icon.css" rel="stylesheet" type="text/css">
    <link href="themes/demo.css" rel="stylesheet" type="text/css">
    <script src="https://registry.npmmirror.com/echarts/5.5.0/files/dist/echarts.min.js"></script>
    <script src="js/jquery.min.js" type="text/javascript"></script>
    <script src="js/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="js/jquery.edatagrid.js" type="text/javascript"></script>
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/stock/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/stock/modules/accessibility.js"></script>
    <style>
        * { margin: 0; padding: 0; }
        .index-container {
            width: 400px;
            height: 600px;
            margin-bottom: 2px;
            background-color: #FFFFCC;
        }
        th, td { text-align: left; padding: 10px; }
        .toggleButton {
            background-color: grey;
            color: black;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
        }
    </style>
</head>
<body>
<table border="1" id="mainTable"></table>
<button id="toggleWk" class="easyui-linkbutton">toggleWk</button>
<button class="toggleButton" id="toggle_300">Toggle 300K</button>
<table border="1" id="myTable"></table>

<script>
    const serverIp = window.location.hostname === 'localhost' ? 'localhost' : '43.139.165.209';
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        function loadTableData() {
            fetch(`http://${serverIp}:8888/bd/indicatorsView/false`)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('myTable').innerHTML = data;
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        loadTableData();

        setTimeout(() => {
            const spans = document.querySelectorAll('div[id^="span_"]');
            spans.forEach(span => {
                createETFChart(span);
            });
        }, 1500);
    });

 async function createETFChart(span) {
    const myChart = echarts.init(span);
    const response = await fetch(`http://${serverIp}:8888/bd/grossDistribute/` + span.id.replace('span_', ''));
    const apiData = await response.json();

    // 补全年份并排序
    const riverData = [];
    const sortedDates = Object.keys(apiData).sort((a, b) => new Date('20' + a) - new Date('20' + b));
    const categories = apiData[sortedDates[0]].map((_, i) => `T${i + 1}`);

    sortedDates.forEach(date => {
        const fullDate = '20' + date; // 把 "24-09-30" → "2024-09-30"
        const values = apiData[date];
        values.forEach((value, idx) => {
            riverData.push([fullDate, value, categories[idx]]);
        });
    });

    const option = {
        backgroundColor: '#fefedc',
        title: {
            left: 'center',
            top: 10,
            textStyle: {
                fontSize: 18,
                fontWeight: 'bold'
            }
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'line',
                lineStyle: {
                    color: '#aaa',
                    width: 1,
                    type: 'dashed'
                }
            },
            formatter: function (params) {
                const date = params[0].data[0];
                let content = `${date}<br/>`;
                params.forEach(p => {
                    content += `${p.marker}${p.seriesName}: ${p.data[1]}<br/>`;
                });
                return content;
            }
        },
        legend: {
            data: categories,
            top: 5
        },
        singleAxis: {
            top: 60,
            bottom: 60,
            type: 'time',
            axisLabel: { rotate: 45 },
            axisPointer: {
                animation: true,
                label: { show: true }
            }
        },
        series: [{
            type: 'themeRiver',
            data: riverData,
            emphasis: {
                focus: 'series'
            }
        }]
    };

    myChart.setOption(option);
}

</script>
</body>
</html>
