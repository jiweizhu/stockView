<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>bdIndicators Day View</title>
    <link href="themes/default/easyui.css" rel="stylesheet" type="text/css">
    <link href="themes/icon.css" rel="stylesheet" type="text/css">
    <link href="themes/demo.css" rel="stylesheet" type="text/css">
    <script src="https://registry.npmmirror.com/echarts/5.5.0/files/dist/echarts.min.js"></script>
    <script src="js/jquery.min.js" type="text/javascript"></script>
    <script src="js/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="js/jquery.edatagrid.js" type="text/javascript"></script>
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/stock/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/stock/modules/accessibility.js"></script>

    <style>
        * { margin: 0; padding: 0; }
        .band-container {
          width: 500px;
          height: 280px;
          margin-bottom: 2px;
          background-color: #FFFFCC;
        }
        th, td { text-align: left; padding: 10px; }

        .toggleButton {
          background-color: grey;
          color: black;
          padding: 10px 15px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          text-align: center;
          text-decoration: none;
        }
    </style>
</head>

<body>
<button id="toggleWk" class="easyui-linkbutton">toggleWk</button>
<button class="toggleButton" id="toggle_300">Toggle 300K</button>
<button class="toggleButton" id="toggle_700">Last 700</button>

<table border="1" id="myTable"></table>

<script>
    const serverIp = window.location.hostname === 'localhost' ? 'localhost' : '43.139.165.209';
</script>

<script>
    let isWeekly = false;
    let show300 = true;
    let lastN = null; // null=全量，700=最近700
    let data_300 = []; // sh000300 的原始数据（或 fallback）

    // 保存每个 span 的 chart 上下文，便于全局按钮重绘
    const chartStore = new Map(); // spanId -> { spanEl, chart, original: {dates, stockData, line300, mm...}, option }

    document.addEventListener('DOMContentLoaded', function () {

      function loadTableData() {
        fetch(`http://${serverIp}:8888/em/bandView`)
          .then(response => response.text())
          .then(data => {
            const dataContainer = document.getElementById('myTable');
            dataContainer.innerHTML = data;
          })
          .catch(error => console.error('Error fetching data:', error));
      }

      loadTableData();

      // ====== 修复点1：统一日期格式 ======
      function normalizeDate(str) {
        if (!str) return '';
        let s = String(str).trim();
        // 支持 "YYYY-MM-DD", "YYYY/MM/DD", "YYYY.MM.DD", "YYYY/M/D"
        s = s.replace(/\./g, '/').replace(/-/g, '/');
        const parts = s.split('/');
        if (parts.length < 3) return s;

        const y = parts[0].padStart(4, '0');
        const m = String(parseInt(parts[1], 10)).padStart(2, '0');
        const d = String(parseInt(parts[2], 10)).padStart(2, '0');
        return `${y}/${m}/${d}`;
      }

      async function safeFetchJson(url) {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`HTTP ${resp.status} for ${url}`);
        return resp.json();
      }

      // ====== 修复点2：右轴用 sh000300（日线优先），不行就 fallback ======
      async function get300Data() {
        if (isWeekly) {
          // 周线你原来就用 sh000300
          data_300 = await safeFetchJson(`http://${serverIp}:8888/bd/wk/stock/sh000300`);
          return;
        }

        // 日线：你要求“右轴是 sh000300”
        try {
          data_300 = await safeFetchJson(`http://${serverIp}:8888/stock/sh000300`);
        } catch (e) {
          // 如果你后端没提供 sh000300 的日线接口，就退回到你原来的 510300
          console.warn('daily sh000300 not available, fallback to sh510300:', e.message);
          data_300 = await safeFetchJson(`http://${serverIp}:8888/stock/sh510300`);
        }
      }

      // 全局绑定按钮（只绑定一次）
      function bindGlobalButtons() {
        document.getElementById('toggleWk').addEventListener('click', async () => {
          isWeekly = !isWeekly;
          await get300Data();
          await rerenderAllCharts(true); // true=重新拉 band 数据（因为 wk/day 不同接口）
        });

        document.getElementById('toggle_300').addEventListener('click', async () => {
          show300 = !show300;
          rerenderAllCharts(false);
        });

        document.getElementById('toggle_700').addEventListener('click', async () => {
          lastN = (lastN === 700) ? null : 700;
          rerenderAllCharts(false);
        });
      }

      async function rerenderAllCharts(needRefetchBand) {
        const spans = document.querySelectorAll('div[id^="span_"]');
        for (const span of spans) {
          await createETFChart(span, needRefetchBand);
        }
      }

      async function initCharts() {
        await get300Data();
        const spans = document.querySelectorAll('div[id^="span_"]');
        for (const span of spans) {
          await createETFChart(span, true);
        }
      }

      bindGlobalButtons();

      // 等 bandView 的 table 注入完成后，再初始化
      setTimeout(() => { initCharts(); }, 1500);

      // =============================
      // 画图主函数
      // =============================
      async function createETFChart(span, forceRefetchBand) {

        // 初始化或复用 chart
        let ctx = chartStore.get(span.id);
        if (!ctx) {
          const chart = echarts.init(span, null, { renderer: 'canvas', useDirtyRect: false });
          ctx = { spanEl: span, chart, rawBand: null, option: null };
          chartStore.set(span.id, ctx);
          window.addEventListener('resize', () => chart.resize(), { passive: true });
        }

        // 1) 拉 band K 线（wk/day）
        if (forceRefetchBand || !ctx.rawBand || ctx.rawBand.isWeekly !== isWeekly) {
          const id = span.id.replace('span_', '');
          const url = `http://${serverIp}:8888/em/${isWeekly ? 'wk/' : ''}band/` + id;
          ctx.rawBand = {
            isWeekly,
            data: await safeFetchJson(url)
          };
        }

        let rawData = Array.isArray(ctx.rawBand.data) ? ctx.rawBand.data : [];

        // ====== 修复点1(续)：band 日期也 normalize ======
        let datesAll = rawData.map(item => normalizeDate(item[0]));
        let stockDataAll = rawData.map(item => [+item[1], +item[2], +item[4], +item[3]]); // O C L H

        // lastN 裁剪
        if (lastN && datesAll.length > lastN) {
          datesAll = datesAll.slice(-lastN);
          stockDataAll = stockDataAll.slice(-lastN);
        }

        // 2) 300 map（同样 normalize 日期）
        const data300Map = new Map(
          (data_300 || []).map(item => {
            const d = normalizeDate(item[0]);
            return [d, [+item[1], +item[2], +item[4], +item[3]]];
          })
        );

        // 3) 按 dates 对齐 300
        const data_300_tmp = datesAll.map(d => data300Map.get(d) || [null, null, null, null]);
        const line_data_300 = data_300_tmp.map(x => x[1]); // close

        // 工具函数：忽略 null 计算 min/max
        const validMinMax = arr => {
          const flat = arr.flat().filter(v => v != null && !isNaN(v));
          if (!flat.length) return { min: 0, max: 1 };
          let mn = Math.min(...flat), mx = Math.max(...flat);
          if (mn === mx) { // 防止轴塌缩
            const pad = Math.abs(mn) * 0.1 || 1;
            mn -= pad; mx += pad;
          }
          return { min: mn, max: mx };
        };

        const stockMM = validMinMax(stockDataAll);
        const data300MM = validMinMax(data_300_tmp);

        function calculateMA(dayCount, data) {
          const result = [];
          for (let i = 0; i < data.length; i++) {
            if (i < dayCount) { result.push('-'); continue; }
            let sum = 0;
            for (let j = 0; j < dayCount; j++) sum += +data[i - j][1]; // close
            result.push(sum / dayCount);
          }
          return result;
        }

        const yAxis300 = {
          type: 'value',
          scale: true,
          name: 'sh000300',
          position: 'right',
          min: data300MM.min,
          max: data300MM.max,
          axisLine: { lineStyle: { color: '#EE9A00' } },
          axisLabel: { show: false },
          splitLine: { show: false },
          axisTick: { show: false }
        };

        const series300 = {
          type: 'line',
          name: 'sh000300',
          data: line_data_300,
          smooth: true,
          showSymbol: false,
          lineStyle: { width: 0.8, color: '#EE9A00' },
          yAxisIndex: 1
        };

        const option = {
          yAxis: [
            {
              type: 'value',
              scale: true,
              name: 'Band',
              position: 'left',
              min: stockMM.min,
              max: stockMM.max,
              axisLine: { lineStyle: { color: '#8392A5' } },
              splitLine: { show: false }
            },
            ...(show300 ? [yAxis300] : [])
          ],
          series: [
            {
              type: 'candlestick',
              name: 'Band',
              data: stockDataAll,
              yAxisIndex: 0,
              itemStyle: {
                color: '#FD1050',
                color0: '#0CF49B',
                borderColor: '#FD1050',
                borderColor0: '#0CF49B'
              }
            },
            {
              name: 'MA5',
              type: 'line',
              data: calculateMA(5, stockDataAll),
              smooth: true,
              showSymbol: false,
              lineStyle: { width: 1 },
              yAxisIndex: 0
            },
            {
              name: 'MA10',
              type: 'line',
              data: calculateMA(10, stockDataAll),
              smooth: true,
              showSymbol: false,
              lineStyle: { width: 1 },
              yAxisIndex: 0
            },
            ...(show300 ? [series300] : [])
          ],
          tooltip: {
            trigger: 'axis',
            axisPointer: {
              animation: false,
              type: 'cross',
              lineStyle: { color: '#376df4', width: 2, opacity: 1 }
            },
            formatter: params => {
              // 简化一点，避免 candlestick 输出数组太乱
              const lines = [];
              const axis = params?.[0]?.axisValueLabel ? `Date: ${params[0].axisValueLabel}` : '';
              if (axis) lines.push(axis);
              for (const p of params) {
                if (p.seriesType === 'candlestick') {
                  const v = p.data || [];
                  lines.push(`${p.seriesName} O:${v[0]} C:${v[1]} L:${v[2]} H:${v[3]}`);
                } else {
                  lines.push(`${p.seriesName}: ${p.data}`);
                }
              }
              return lines.join('<br>');
            }
          },
          xAxis: {
            type: 'category',
            data: datesAll,
            axisLine: { lineStyle: { color: '#8392A5' } }
          },
          grid: { top: '3%', bottom: 80, right: show300 ? 55 : 20 },
          dataZoom: [
            {
              textStyle: { color: '#8392A5' },
              handleIcon:
                'path://M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
              dataBackground: {
                areaStyle: { color: '#8392A5' },
                lineStyle: { opacity: 0.8, color: '#8392A5' }
              },
              brushSelect: true
            },
            { type: 'inside' }
          ]
        };

        ctx.option = option;
        ctx.chart.setOption(option, true);
      }
    });
</script>
</body>
</html>
