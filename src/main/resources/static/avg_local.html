<!DOCTYPE html>
<html lang="zh-CN" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8">
    <title>ShangHai Index, 2015 - Apache ECharts Demo</title>
    <script src="https://registry.npmmirror.com/echarts/5.5.0/files/dist/echarts.min.js"></script>
    <style>
* {
  margin: 0;
  padding: 0;
}
.chart-container {
    width: 350px;
    height: 320px;
    margin-bottom: 2px;
}
.index-container {
    width: 400px;
    height: 300px;
    margin-bottom: 2px;
    background-color: #FFFFCC;
}
.multiLine-container {
    width: 550px;
    height: 320px;
    margin-bottom: 2px;
}

.vertical-stockId {
    writing-mode: vertical-rl;
    text-orientation: upright;
    border: 1px solid #000;
    padding: 10px;
    font-size: 5px;
}

.vertical-stockName {
    writing-mode: vertical-rl;
    text-orientation: upright;
<!--    border: 1px solid #000;-->
    padding: 10px;
    font-size: 20px;
}
    </style>
</head>
<body>
<button id="getDivs">getDivs</button>
<button id="generateChart">generateChart</button>
<table border="1" id="mainTable">
<!--    <tr>-->
<!--        <td ><div>sh510760_上证综指ETF</div><div id="span_sh510760_上证综指ETF" class="index-container"></div></td>-->
<!--        <td ><div>sh510300_沪深300ETF</div><div id="span_sh510300_沪深300ETF" class="index-container"></div></td>-->
<!--        <td ><div>sh510500_中证500ETF</div><div id="span_sh510500_中证500ETF" class="index-container"></div></td>-->
<!--        <td ><div>sh512100_中证1000ETF</div><div id="span_sh512100_中证1000ETF" class="index-container"></div></td>-->
<!--    </tr>-->
<!--    <tr>-->
<!--        <td ><div>sz159949_创业板50ETF</div><div id="span_sz159949_创业板50ETF" class="index-container"></div></td>-->
<!--        <td ><div>sh588080_科创板50ETF</div><div id="span_sh588080_科创板50ETF" class="index-container"></div></td>-->
<!--        <td ><div>sh510190_上证50ETF</div><div id="span_sh510190_上证50ETF" class="index-container"></div></td>-->
<!--        <td ><div>sz159915_创业板ETF</div><div id="span_sz159915_创业板ETF" class="index-container"></div></td>-->
<!--    </tr>-->

</table>
<table border="1" id="myTable"></table>

<script src="https://registry.npmmirror.com/echarts/5/files/dist/echarts.min.js"></script>
<script>

document.getElementById('getDivs').addEventListener('click', getDivs);

document.addEventListener('DOMContentLoaded', function () {
   function loadTableData() {
      fetch('http://localhost:8888/etfs/3')
         .then(response => response.text())
         .then(data => {
            const dataContainer = document.getElementById('myTable');
            dataContainer.innerHTML = data;
         })
         .catch(error => {
            console.error('Error fetching data:', error);
         })
   }

   function loadIndexTableData() {
      fetch('http://localhost:8888/etfs/main')
         .then(response => response.text())
         .then(data => {
            const dataContainer = document.getElementById('mainTable');
            dataContainer.innerHTML = data;
         })
         .catch(error => {
            console.error('Error fetching data:', error);
         })
   }

loadTableData();
loadIndexTableData();
setTimeout(function() {
    getDivs();
}, 3000);
});


async function getDivs() {
   const spans = document.querySelectorAll('div[id^="span_"]');
spans.forEach(span => {
   createChart(span);
   createMultiChart();
});}


async function createChart(span) {

var myChart = echarts.init(span, null, {
  renderer: 'canvas',
  useDirtyRect: false
});

const rawData = await fetch('http://localhost:8888/stock/'+span.id.replace('span_', '')).then(response => response.json());

function calculateMA(dayCount, data) {
  var result = [];
  for (var i = 0, len = data.length; i < len; i++) {
    if (i < dayCount) {
      result.push('-');
      continue;
    }
    var sum = 0;
    for (var j = 0; j < dayCount; j++) {
      sum += +data[i - j][1];
    }
    result.push(sum / dayCount);
  }
  return result;
}
const dates = rawData.map(item => item[0]);
const data =rawData.map(item => [+item[1], +item[2], +item[4], +item[3]]);
option = {
  legend: {
    data: ['日K', 'MA5', 'MA10'],
    inactiveColor: '#777'
  },
  tooltip: {
    trigger: 'axis',
    axisPointer: {
      animation: false,
      type: 'cross',
      lineStyle: {
        color: '#376df4',
        width: 2,
        opacity: 1
      }
    }
  },
  xAxis: {
    type: 'category',
    data: dates,
    axisLine: { lineStyle: { color: '#8392A5' } }
  },
  yAxis: {
    scale: true,
    axisLine: { lineStyle: { color: '#8392A5' } },
    splitLine: { show: false }
  },
  grid: {
    bottom: 80
  },
  dataZoom: [
    {
      textStyle: {
        color: '#8392A5'
      },
      handleIcon:
        'path://M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
      dataBackground: {
        areaStyle: {
          color: '#8392A5'
        },
        lineStyle: {
          opacity: 0.8,
          color: '#8392A5'
        }
      },
      brushSelect: true
    },
    {
      type: 'inside'
    }
  ],
  series: [
    {
      type: 'candlestick',
      name: 'Day',
      data: data,
      itemStyle: {
        color: '#FD1050',
        color0: '#0CF49B',
        borderColor: '#FD1050',
        borderColor0: '#0CF49B'
      }
    },
    {
      name: 'MA5',
      type: 'line',
      data: calculateMA(5, data),
      smooth: true,
      showSymbol: false,
      lineStyle: {
        width: 1
      }
    },
    {
      name: 'MA10',
      type: 'line',
      data: calculateMA(10, data),
      smooth: true,
      showSymbol: false,
      lineStyle: {
        width: 1
      }
    }
  ]
};

    if (option && typeof option === 'object') {
      myChart.setOption(option);
    }

    window.addEventListener('resize',() => myChart.resize());

}


</script>
<script>

async function createMultiChart() {
var dom = document.getElementById('multi_sz159516');
var myChart = echarts.init(dom, null, {
  renderer: 'canvas',
  useDirtyRect: false
});
var app = {};

var option;

option = {
  title: {
<!--    text: 'Stacked Line'-->
  },
  tooltip: {
    trigger: 'axis'
  },
  legend: {
    data: ['Email', 'Union Ads', 'Video Ads', 'Direct', 'Search Engine']
  },
  grid: {
    left: '3%',
    right: '4%',
    bottom: '3%',
    containLabel: true
  },
  toolbox: {
    feature: {
      saveAsImage: {}
    }
  },
  xAxis: {
    type: 'category',
    boundaryGap: false,
    data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
  },
  yAxis: {
    type: 'value'
  },
  series: [
    {
      name: 'Email',
      type: 'line',
      stack: 'Total',
      data: [120, 132, 101, 134, 90, 230, 210]
    },
    {
      name: 'Union Ads',
      type: 'line',
      stack: 'Total',
      data: [220, 182, 191, 234, 290, 330, 310]
    },
    {
      name: 'Video Ads',
      type: 'line',
      stack: 'Total',
      data: [150, 232, 201, 154, 190, 330, 410]
    },
    {
      name: 'Direct',
      type: 'line',
      stack: 'Total',
      data: [320, 332, 301, 334, 390, 330, 320]
    },
    {
      name: 'Search Engine',
      type: 'line',
      stack: 'Total',
      data: [820, 932, 901, 934, 1290, 1330, 1320]
    }
  ]
};

if (option && typeof option === 'object') {
  myChart.setOption(option);
}

window.addEventListener('resize', myChart.resize);
}


</script>
</body>
</html>